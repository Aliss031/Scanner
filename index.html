from flask import Flask, render_template_string, request, jsonify, url_for
import os, re
from werkzeug.utils import secure_filename

# Example: initialize your OCR + Firebase setup
from your_ocr_module import EASYOCR_READER, preprocess_image, ocr_tesseract
from your_firebase_module import check_pin_in_db, save_parcel_record

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = "uploads"

# ------------------------------------------------------------
# FRONTEND: main interface
# ------------------------------------------------------------
@app.route("/")
def index():
    return render_template_string(""" 
    <!-- (Your Tailwind-styled HTML UI goes here ‚Äî the one you shared earlier) -->
    """)


# ------------------------------------------------------------
# BACKEND: scanning endpoint
# ------------------------------------------------------------
@app.route("/scan", methods=["POST"])
def scan_frame():
    detected_number = None
    phone_number = None
    parcel_no = None
    unique_id = None
    all_text = []

    if "frame" not in request.files:
        return jsonify({"number": None, "phone": None, "all_text": []})

    file = request.files["frame"]
    filename = secure_filename(file.filename)
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    file.save(filepath)

    processed = preprocess_image(filepath)
    if processed is None:
        return jsonify({"number": None, "phone": None, "all_text": []})

    # üîç Run EasyOCR
    results = EASYOCR_READER.readtext(processed)
    all_text = [text for (_, text, _) in results]

    # üßæ Detect PIN (6-digit number)
    easy_matches = [re.sub(r"\D", "", text) for text in all_text if re.fullmatch(r"\d{6}", re.sub(r"\D", "", text))]
    if easy_matches:
        detected_number = easy_matches[0]
    else:
        tess_matches = ocr_tesseract(processed)
        if tess_matches:
            detected_number = tess_matches[0]

    # üîó Lookup in database
    if detected_number:
        phone_number = check_pin_in_db(detected_number)
        if phone_number:
            parcel_no, unique_id = save_parcel_record(phone_number)
        else:
            print(f"‚ö† PIN {detected_number} not in database")
    else:
        print("‚ùå No 6-digit number found")

    # üß† Return results to front-end
    return jsonify({
        "number": detected_number,
        "phone": phone_number,
        "parcel_no": parcel_no,
        "unique_id": unique_id,
        "all_text": all_text
    })


if __name__ == "__main__":
    os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)
    app.run(debug=True)
